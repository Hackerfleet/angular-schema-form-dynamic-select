<div
    ng-controller="dynamicSelectController"
    ng-class="{
        'has-error': hasError(),
        'has-success': hasSuccess(),
        'has-feedback': form.feedback !== false
    }"
    class="form-group">

    <label class="control-label" ng-show="showTitle()">{{form.title}}</label>

    <div class="form-group">
        <ui-select
            multiple
            sortable-options="{{form.sortableOptions}}"
            ng-model="form.$$selectedObjects"
            theme="bootstrap"
            on-select="form.$$selectedValues.push($item.value)"
            on-remove="form.$$selectedValues.splice(form.$$selectedValues.indexOf($item.value), 1)"
            class="{{form.options.uiClass}}">

            <ui-select-match
                placeholder="{{
                    form.placeholder ||
                    form.schema.placeholder ||
                    ('placeholders.select' | translate)}}
                ">
                {{$item.name}}
            </ui-select-match>

            <ui-select-choices
                refresh="populateTitleMap(form, $select.search)"
                refresh-delay="form.options.refreshDelay"
                group-by="form.options.groupBy"
                repeat="item in form.titleMap | propsFilter: {
                    name: $select.search,
                    description: (form.options.searchDescriptions===true ? $select.search : 'NOTSEARCHINGFORTHIS')
                } track by $index">

                <div ng-bind-html="item.name | highlight: $select.search"></div>

                <div ng-if="item.description">
                    <span ng-bind-html="
                        '<small>' +
                            (''+item.description | highlight: (form.options.searchDescriptions===true ? $select.search : 'NOTSEARCHINGFORTHIS')) +
                        '</small>'">
                    </span>
                </div>
            </ui-select-choices>
        </ui-select>

        <input
            type="hidden"
            name="{{form.key.slice(-1)[0]}}"
            toggle-multiple-model
                ng-model="$$value$$"
                form="form"
            sf-changed="form"
            schema-validate="form"/>

        <span
            ng-if="form.feedback !== false"
            ng-class="evalInScope(form.feedback) || {
                'glyphicon': true,
                'glyphicon-ok': hasSuccess(),
                'glyphicon-remove': hasError()
            }"
            class="form-control-feedback">
        </span>

        <div class="help-block" sf-message="form.description"></div>
    </div>
</div>
