<div ng-controller="dynamicSelectController"
     ng-class="{
        'has-error': hasError(),
        'has-success': hasSuccess(),
        'has-feedback': form.feedback !== false
    }"
    class="form-group">

    <label class="control-label" ng-show="showTitle()">{{form.title}}</label>

    <div class="form-group">
        <!-- 1. NO Tagging -->
        <!-- NOTE: ng-if creates a new scope, so any change made in the child will obscure any parent scope var unless "dot rule" -->
        <ui-select
            ng-if="!(form.options.tagging||false)"
            ng-model="form.$$selectedObject"
            ng-disabled="form.disabled"
            theme="bootstrap"
            class="{{form.options.uiClass}}">

            <ui-select-match
                allow-clear="{{form.options.allowClear||false}}"
                placeholder="{{form.placeholder || form.schema.placeholder || ('placeholders.select' | translate)}}">
                {{form.$$selectedObject.name}}
            </ui-select-match>

            <ui-select-choices
                refresh="populateTitleMap(form, $select.search)"
                refresh-delay="form.options.refreshDelay"
                group-by="form.options.groupBy"
                repeat="item in form.titleMap | propsFilter: {
                    name: $select.search,
                    description: (form.options.searchDescriptions===true ? $select.search : 'NOTSEARCHINGFORTHIS')
                } track by $index">

                <div ng-bind-html="item.name | highlight: $select.search"></div>

                <div ng-if="item.description">
                    <span ng-bind-html="
                        '<small>' +
                            (''+item.description | highlight: (form.options.searchDescriptions===true ? $select.search : 'NOTSEARCHINGFORTHIS')) +
                        '</small>'">
                    </span>
                </div>
            </ui-select-choices>
        </ui-select>

        <!--repeat because annoying bug: allow-clear and tagging won't remove the first item: https://github.com/angular-ui/ui-select/issues/954 -->
        <!-- 2. Tagging  -->
        <ui-select
            ng-if="(form.options.tagging||false)"
            ng-model="form.$$selectedObject"
            ng-disabled="form.disabled"
            tagging="(getTaggingFn(form.options.tagging))"
            tagging-label="{{form.options.taggingLabel||'(new)'}}"
            tagging-tokens="{{form.options.taggingTokens}}||;|,"
            theme="bootstrap"
            class="{{form.options.uiClass}}">

            <ui-select-match
                allow-clear="{{form.options.allowClear||false}}"
                placeholder="{{
                    form.placeholder ||
                    form.schema.placeholder ||
                    ('placeholders.select' | translate)}}">
                {{form.$$selectedObject.name||form.$$selectedObject.value}}&nbsp;
                <small ng-if="form.$$selectedObject.isTag">
                    {{($select.taggingLabel)}}
                </small>
            </ui-select-match>

            <ui-select-choices
                group-by="form.options.groupBy"
                refresh="populateTitleMap(form, $select.search)"
                refresh-delay="form.options.refreshDelay"
                repeat="item in form.titleMap | propsFilter: {
                    name: $select.search,
                    description: (form.options.searchDescription===true ? $select.search : 'NOTSEARCHINGFORTHIS'
                    )
                } track by $index">

                <!-- Newly created element (tag) -->
                <div ng-if="item.isTag"
                    ng-bind-html="
                        '<div>' +
                            (item.name | highlight: $select.search) +
                            ' ' + form.options.taggingLabel +
                        '</div>' +
                        '<div class=&quot;divider&quot;></div>' ">
                        <!-- Show a separator between the new item and the standard one -->
                </div>

                <div ng-if="!item.isTag"
                    ng-bind-html="item.name + item.isTag| highlight: $select.search">
                </div>

                <div ng-if="item.description">
                    <span ng-bind-html="
                        '<small>' +
                            (''+item.description | highlight: (form.options.searchDescriptions===true ? $select.search : 'NOTSEARCHINGFORTHIS')) +
                       '</small>'">
                    </span>
                </div>

            </ui-select-choices>
        </ui-select>

        <input
            type="hidden"
            name="{{form.key.slice(-1)[0]}}"
            toggle-single-model
                ng-model="$$value$$"
                form="form"
            sf-changed="form"
            schema-validate="form"/>

        <span
            ng-if="form.feedback !== false"
            ng-class="evalInScope(form.feedback) || {
                'glyphicon': true,
                'glyphicon-ok': hasSuccess(),
                'glyphicon-remove': hasError()
            }"
            class="form-control-feedback"
            id="{{form.key.slice(-1)[0] + 'Status'}}">
        </span>

        <div class="help-block" sf-message="form.description"></div>

    </div>
</div>
